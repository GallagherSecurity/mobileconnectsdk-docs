<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
<link rel="stylesheet" href="https://raw.githubusercontent.com/isagalaev/highlight.js/master/src/styles/androidstudio.css">

<style type="text/css">
html, body {
    font-family:'Segoe UI', 'San Francisco', sans-serif;
}
h1, h2, h3, h4, h5, h6 {
    color: #ff7900;
}
</style>
</head>
<body>
<h1>Mobile Connect SDK for Android - Developer Guide</h1>
<h2>Contents</h2>
<ul>
<li><a href="#prerequisites">Pre-requisites</a></li>
<li><a href="#gettingstarted">Getting Started</a>
<ul>
<li><a href="#configure_sdk">Configure the Mobile Connect SDK</a></li>
</ul>
</li>
<li><a href="#mobilecredentials">Mobile Credentials</a>
<ul>
<li><a href="#mobilecredentials_register">Registration</a></li>
<li><a href="#mobilecredentials_list">Listing Credentials</a></li>
<li><a href="#mobilecredentials_deregister">Deleting</a></li>
</ul>
</li>
<li><a href="#readeraccess">Reader Discovery and Access</a>
<ul>
<li><a href="#reader_verifysdk">Verifying if the SDK is functioning</a></li>
<li><a href="#reader_autoconnect">Auto-connect</a></li>
<li><a href="#reader_discovery">Discovery of readers</a></li>
<li><a href="#reader_manualconnect">Manual connect</a></li>
</ul>
</li>
<li><a href="#faq">Frequently Asked Questions</a></li>
<li><a href="#customising">Troubleshooting / Customising the SDK</a>
<ul>
<li><a href="#configure_logging">Configure logging (optional)</a></li>
<li><a href="#configure_notifications">Configure Android Notifications</a></li>
<li><a href="#configure_messages">Customising SDK messages</a></li>
</ul>
</li>
</ul>
<h2>Pre-requisites<a name=prerequisites></a></h2>
<ul>
<li>This developer guide references version <strong>14.0.010</strong> of the Gallagher Mobile Connect SDK for Android</li>
<li>Android Studio (This document tested against Android Studio 4.0)</li>
<li>An app targeting Android 5.0 or later</li>
</ul>
<h2>Getting Started<a name=gettingstarted></a></h2>
<h3>1. Add the SDK files to your project</h3>
<p>Unzip the zip file.</p>
<p>Place the <code>gallagher-mobile-access</code> directory under the <code>app</code> folder of your Android Studio project.</p>
<p>Example:</p>
<p><img src="img/android-studio-app-folder.png" alt="example"></p>
<h3>2. Edit <code>build.gradle</code> under your <code>app</code> folder</h3>
<p>Add a <code>repositories</code> section with the value<br>
<code>maven { url &quot;file://$projectDir/gallagher-mobile-access&quot; }</code></p>
<p>Also add Java version 8 source compatibility</p>
<p>Also add the <code>gallaghermobileaccess</code> library to your dependencies</p>
<p>Example:</p>
<pre><code class="language-gradle">apply plugin: <span class="hljs-string">'com.android.application'</span>

<span class="hljs-keyword">repositories</span> {
    maven { url <span class="hljs-string">"file://$projectDir/gallagher-mobile-access"</span> }
}

android {
    compileSdkVersion <span class="hljs-number">29</span>

    compileOptions {
        <span class="hljs-keyword">sourceCompatibility</span> JavaVersion.VERSION_1_8
        <span class="hljs-keyword">targetCompatibility</span> JavaVersion.VERSION_1_8
    }

    <span class="hljs-comment">// defaultConfig, buildTypes, etc</span>
}

<span class="hljs-keyword">dependencies</span> {
    <span class="hljs-comment">// androidx, etc</span>
    implementation <span class="hljs-string">'com.gallagher.security:gallaghermobileaccess:&lt;VERSION&gt;'</span>
    <span class="hljs-comment">// other libs</span>
}
</code></pre>
<h3>3. Edit <code>AndroidManifest.xml</code></h3>
<p>Add the following within your <code>&lt;application&gt;</code> tag:</p>
<pre><code class="language-xml"><span class="hljs-comment">&lt;!-- Required for Bluetooth Background Access - Not required if you only want foreground --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">service</span> 
    <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.gallagher.security.mobileaccess.BleBackgroundService"</span>
    <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"false"</span>
    <span class="hljs-attr">android:stopWithTask</span>=<span class="hljs-string">"false"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- Required for NFC Access - Not required if you only want bluetooth (e.g. Manual Connect only) --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">service</span>
    <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.gallagher.security.mobileaccess.NfcBackgroundService"</span>
    <span class="hljs-attr">android:enabled</span>=<span class="hljs-string">"true"</span>
    <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"true"</span>
    <span class="hljs-attr">android:permission</span>=<span class="hljs-string">"android.permission.BIND_NFC_SERVICE"</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.nfc.cardemulation.action.HOST_APDU_SERVICE"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span>
        <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.nfc.cardemulation.host_apdu_service"</span>
        <span class="hljs-attr">android:resource</span>=<span class="hljs-string">"@xml/ggl_apduservice"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">service</span>&gt;</span>
</code></pre>
<p>Add the following within your <code>&lt;manifest&gt;</code> tag, before the <code>&lt;application&gt;</code> tag:</p>
<pre><code class="language-xml"><span class="hljs-comment">&lt;!-- Credential registration --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.INTERNET"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- Bluetooth LE --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-feature</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.hardware.bluetooth_le"</span> <span class="hljs-attr">android:required</span>=<span class="hljs-string">"true"</span> /&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.BLUETOOTH"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.BLUETOOTH_ADMIN"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- Required for Android 6.0 and later when using Bluetooth LE --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.ACCESS_COARSE_LOCATION"</span> /&gt;</span>
<span class="hljs-comment">&lt;!-- Required for Android 10 and later when using Bluetooth LE --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.ACCESS_FINE_LOCATION"</span> /&gt;</span>
<span class="hljs-comment">&lt;!-- Required for Android 10 and later when using Bluetooth LE while the app is not on-screen --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.ACCESS_BACKGROUND_LOCATION"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- NFC --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.NFC"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- Unlock notification wakes the screen --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.WAKE_LOCK"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- permission to run as a foreground service to enable BLE scanning https://developer.android.com/about/versions/pie/android-9.0-changes-28 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.FOREGROUND_SERVICE"</span> /&gt;</span>
</code></pre>
<h3>4. Configure the Mobile Connect SDK within your application.<a name=configure_sdk></a></h3>
<p>The SDK must be configured before it can be used. To do this, call the <code>MobileAccessProvider.configure</code> method.
We recommend you do this in your <code>Application onCreate</code> method. If you are using background access (either bluetooth or NFC) and you do not configure the SDK at or before <code>Application onCreate</code>, then the SDK may crash on launch.</p>
<p>The configure method has the following arguments:</p>
<ul>
<li><code>application</code>: Required. A reference to the Android Application instance</li>
<li><code>databaseFilePath</code>: Optional (you may pass <code>null</code>). The filesystem location at which the SDK stores it's internal SQLite database</li>
<li><code>unlockNotificationChannelId</code>: Required if you are going to use either Bluetooth or NFC Background access, otherwise you may pass <code>null</code>. See <strong>Configuring Android Notifications</strong> under the <strong>Troubleshooting / Customising the SDK</strong> section at the end of this document.</li>
<li><code>bleServiceForegroundNotificationChannelId</code>: Required if you are going to use Bluetooth Background Access, otherwise you may pass <code>null</code>. See <strong>Configuring Android Notifications</strong> under the <strong>Troubleshooting / Customising the SDK</strong> section at the end of this document.</li>
</ul>
<p>You may use the <code>MobileAccessProvider.getInstance()</code> method to obtain a reference to the SDK via the <code>MobileAccess</code> interface from any point in your application, however you MUST have called <code>MobileAccessProvider.configure()</code> first. Attempting to get <code>getInstance()</code> without configure will result in a Runtime exception being thrown.</p>
<p><strong>Reference:</strong><br>
<a href="javadoc/com/gallagher/security/mobileaccess/MobileAccessProvider.html">MobileAccessProvider</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/MobileAccess.html">MobileAccess</a></p>
<p>In order to get the SDK up and running, you will most likely want to call <code>setScanning(true)</code>.</p>
<p>Below is an example of an application which starts scanning and auto-connect upon launch.</p>
<p>If you do not have any such existing infrastructure, the simplest way to do this is to implement a custom <code>Application</code> class for your android app.</p>
<ul>
<li>Find the <code>&lt;application&gt;</code> tag in your AndroidManifest.xml, and add the following attribute:
<code>android:name=&quot;.Application&quot;</code></li>
<li>Create a class called <code>Application</code>, with the following content (note: package imports omitted)</li>
</ul>
<pre><code class="language-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Application</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">android</span>.<span class="hljs-title">app</span>.<span class="hljs-title">Application</span> </span>{
    <span class="hljs-keyword">private</span> MobileAccess mMobileAccess;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> </span>{
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState);

        mMobileAccess = MobileAccessProvider.configure(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

        mMobileAccess.setScanning(<span class="hljs-keyword">true</span>);
        mMobileAccess.setAutomaticAccessEnabled(<span class="hljs-keyword">true</span>);
    }
}
</code></pre>
<p>At this point you should be able to compile and launch your app successfully.</p>
<p>The SDK is now waiting until you register at least one mobile credential, after which point it can be used for access.</p>
<h2>Mobile Credentials<a name=mobilecredentials></a></h2>
<p>In order to gain access or communicate with readers over Bluetooth or NFC, you must first have a registered credential to authenticate your user and device.</p>
<p>Mobile credentials are created in Command Centre, either using the Command Centre Client, or via the Command Centre REST api.</p>
<h3>1. <a name=mobilecredentials_register></a>Registering a Mobile Credential</h3>
<p>The key piece of information which enables you to register a mobile credential is the <strong>invitation URL</strong>. The invitation URL consists of the address of the Gallagher Cloud service, and a unique one-time-use invitation code.</p>
<p>If you are creating credentials using the REST api, you will also be able to use it to retrieve the invitation URL. Please refer to the server-side integration guide and REST api documentation for more information.</p>
<p>You can also build the invitation url using the <code>resolveInvitationUri(invitationBaseUrl, invitationCode)</code> method in the Mobile Connect SDK.<br>
Given an invitation code, and the hostname of the Gallagher Cloud Server (https://commandcentre-ap-southeast-2.security.gallagher.cloud) you may call this method to generate the invitation URL.</p>
<p>When getting started, the easiest option will most likely be to use the Command Centre client to send yourself a credential invitation email in the same way you would for the Gallagher Mobile Connect app.
Rather than opening the invitation with the Gallagher app, instead, scroll down and copy the <strong>invitation code</strong> from the &quot;Manual Registration&quot; section of the standard Gallagher invitation email message.</p>
<p><strong>Note:</strong> By default, credentials sent for the Mobile Connect app will also require a second step of SMS verification. <strong>SMS verification is not supported for third-party apps using the Mobile Connect SDK</strong>, so in order to email yourself a credential without the SMS step you must create a new Mobile Credential Card Type using the Command Centre Configuration client, and use this card type when sending your test credential email.</p>
<p><img src="img/mobile-credential-cardtype-no-sms.png" alt="Mobile Credential Configuration screenshot"></p>
<p>Once you have obtained the invitation URL, use the <code>registerCredential(invitationUri, registrationListener)</code> method to begin the registration process. The SDK will asynchronously call the callback methods on the <code>registrationListener</code> to inform you of success or failure. Callbacks will arive on the main thread.</p>
<p><em>Example:</em></p>
<pre><code class="language-java"><span class="hljs-keyword">try</span> {
    URI invitationUri = ...
    mMobileAccess.registerCredential(invitationUri, <span class="hljs-keyword">new</span> RegistrationListener() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onRegistrationCompleted</span><span class="hljs-params">(@Nullable MobileCredential credential, @Nullable RegistrationError error)</span> </span>{
            <span class="hljs-keyword">if</span>(error != <span class="hljs-keyword">null</span>) {
                Toast.makeText(context, error.getLocalizedMessage(), Toast.LENGTH_LONG).show();
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(credential != <span class="hljs-keyword">null</span>) {
                Toast.makeText(context, <span class="hljs-string">"Registered!"</span>, Toast.LENGTH_SHORT).show();
            }
        }

        <span class="hljs-comment">// If the credential allows for second-factor authentication, then we need </span>
        <span class="hljs-comment">// to ask the user which method they'd prefer; Fingerprint or PIN?</span>
        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onAuthenticationTypeSelectionRequested</span><span class="hljs-params">(SecondFactorAuthenticationTypeSelector selector)</span> </span>{
            <span class="hljs-comment">// pop a dialog here and ask the user their preference. </span>
            <span class="hljs-comment">// In response to the dialog call selector.select</span>
            selector.select(<span class="hljs-keyword">true</span>, SecondFactorAuthenticationType.FINGERPRINT); 
        }
    });
} <span class="hljs-keyword">catch</span> (URISyntaxException e) {
    e.printStackTrace();
}
</code></pre>
<p>For a comprehensive example, please see the file <code>RegistrationsFragment.java</code> in the Android SDK sample application.</p>
<p><strong>Note:</strong> When registering, the user will be prompted to choose a second-factor method - either PIN or Fingerprint. In order for this to succeed, their phone must have the system-level PIN/passcode lock enabled. <a href="#faq_device_pin_required">See FAQ</a></p>
<p><strong>Reference:</strong><br>
<a href="javadoc/com/gallagher/security/mobileaccess/MobileAccess.html">MobileAccess</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/RegistrationListener.html">RegistrationListener</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/MobileCredential.html">MobileCredential</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/SecondFactorAuthenticationTypeSelector.html">SecondFactorAuthenticationTypeSelector</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/SecondFactorAuthenticationType.html">SecondFactorAuthenticationType</a></p>
<h3>2. <a name=mobilecredentials_list></a>Listing Registered Credentials</h3>
<p>Use the <code>getMobileCredentials()</code> method. This will return <code>Collection&lt;MobileCredential&gt;</code> - which you should copy into your own <code>ArrayList</code> or other stable collection.</p>
<p><strong>Reference:</strong><br>
<a href="javadoc/com/gallagher/security/mobileaccess/MobileAccess.html">MobileAccess</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/MobileCredential.html">MobileCredential</a></p>
<h3>3. <a name=mobilecredentials_deregister></a>Deleting a Mobile Credential</h3>
<p>Use the <code>deleteMobileCredential(mobileCredential, credentialDeleteListener)</code> method. The SDK will asynchronously call the callback methods on the <code>credentialDeleteListener</code> to inform you of success or failure. Callbacks will arive on the main thread.</p>
<p>You can obtain a reference to the credential object to delete by calling <code>getMobileCredentials()</code>. Mobile Credential objects have a <code>getId()</code> method which you should use if you wish to compare instances.</p>
<p><em>Example:</em></p>
<pre><code class="language-java">mMobileAccess.deleteMobileCredential(item, (credential, error) -&gt; {
    <span class="hljs-keyword">if</span>(error != <span class="hljs-keyword">null</span>) {
        Toast.makeText(getActivity(), <span class="hljs-string">"Error "</span> + error.getLocalizedMessage(), Toast.LENGTH_LONG).show();
    } <span class="hljs-keyword">else</span> {
        Toast.makeText(getActivity(), <span class="hljs-string">"Deleted!"</span>, Toast.LENGTH_SHORT).show();
    }
});
</code></pre>
<p><strong>Reference:</strong><br>
<a href="javadoc/com/gallagher/security/mobileaccess/MobileAccess.html">MobileAccess</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/CredentialDeleteListener.html">CredentialDeleteListener</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/MobileCredential.html">MobileCredential</a></p>
<h2>Reader Discovery and Access<a name=readeraccess></a></h2>
<h3>1. Verifying if the SDK is functioning<a name=reader_verifysdk></a></h3>
<p>There are a variety of reasons why the SDK may not work even though you have called <code>setScanning</code>, such as Bluetooth or NFC being disabled in your device system settings, lack of permissions, etc.</p>
<p>You should use the <code>addSdkStateListener(sdkStateListener)</code> method. The SDK will asynchronously call the callback methods on the <code>sdkStateListener</code> to inform you of state changes. Callbacks will arive on the main thread.</p>
<p>You may wish to log these state changes, or prompt the user to perform some action (such as granting permissions, or giving them a button to click to enable Bluetooth, etc)</p>
<p><em>Example:</em></p>
<pre><code class="language-java">mMobileAccess.addSdkStateListener(<span class="hljs-keyword">this</span>);
<span class="hljs-comment">// ...</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onStateChanged</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isScanning, Collection&lt;MobileAccessState&gt; states)</span> </span>{
    ArrayList&lt;String&gt; messages = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-keyword">for</span>(MobileAccessState state : states) {
        <span class="hljs-keyword">switch</span> (state) {
            <span class="hljs-keyword">case</span> NO_CREDENTIALS:
                messages.add(<span class="hljs-string">"Please register a credential"</span>);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> NFC_DISABLED:
                messages.add(<span class="hljs-string">"NFC is disabled; Please enable it to allow access using NFC"</span>);
                <span class="hljs-keyword">break</span>;
        }
    }
    <span class="hljs-comment">// display messages in a RecyclerView for example</span>
}
</code></pre>
<p><strong>Reference:</strong><br>
<a href="javadoc/com/gallagher/security/mobileaccess/MobileAccess.html">MobileAccess</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/SdkStateListener.html">SdkStateListener</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/MobileAccessState.html">MobileAccessState</a></p>
<h3>1. Auto-connect<a name=reader_autoconnect></a></h3>
<p>You must call the <code>enableAutomaticAccess()</code> method in order to enable auto-connect. You can call <code>disableAutomaticAccess()</code> to disable it later if you require. Note that enabling and disabling automatic access does not affect bluetooth scanning, which continues until you call <code>stopScanning()</code></p>
<p>By default, the Mobile Connect SDK will automatically attempt to connect to any nearby readers if the device enters the configured range.</p>
<p>If you wish to be informed about auto connect events, use the <code>addAutomaticAccessListener(automaticAccessListener)</code> method. The SDK will asynchronously call the callback methods on the <code>automaticAccessListener</code> to inform you of success or failure. Callbacks will arive on the main thread.</p>
<p>Any calls to <code>addAutomaticAccessListener</code> should be balanced by a call to <code>removeAutomaticAccessListener</code> to prevent memory leaks.</p>
<p><em>Example:</em></p>
<pre><code class="language-java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> </span>{
    mMobileAccess.addAutomaticAccessListener(<span class="hljs-keyword">this</span>);
}

<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onDestroy</span><span class="hljs-params">()</span> </span>{
    mMobileAccess.removeAutomaticAccessListener(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">super</span>.onDestroy();
}

<span class="hljs-comment">// ...</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onAccessStarted</span><span class="hljs-params">(@NonNull Reader reader)</span> </span>{
    updateDisplayState(reader, ACTIVE);
}

<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onAccessCompleted</span><span class="hljs-params">(@NonNull Reader reader, @Nullable AccessResult accessResult, @Nullable ReaderConnectionError error)</span> </span>{
    <span class="hljs-keyword">if</span>(error != <span class="hljs-keyword">null</span>) {
        updateDisplayState(reader, ERROR);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(accessResult != <span class="hljs-keyword">null</span>) {
        updateDisplayState(
            reader, 
            accessResult.isAccessGranted() ? GRANTED : DENIED);
    }
}
</code></pre>
<p><strong>Reference:</strong><br>
<a href="javadoc/com/gallagher/security/mobileaccess/MobileAccess.html">MobileAccess</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/AutomaticAccessListener.html">AutomaticAccessListener</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/Reader.html">Reader</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/AccessResult.html">AccessResult</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/ReaderConnectionError.html">ReaderConnectionError</a></p>
<h3>2. Discovery of readers<a name=reader_discovery></a></h3>
<p>Use the <code>setReaderUpdateListener(readerUpdateListener)</code> method to provide a callback to be called when a reader is discovered via Bluetooth or NFC.</p>
<p>If you wish to show an interactive list of nearby readers in your application, you can use this to maintain a list of readers and other related information (such as visual state, appearance, etc) and display that information.</p>
<p>If your app only wants to use the auto-connect feature of the Mobile Connect SDK, then you can skip this section; The SDK will work regardless of whether you call <code>setReaderUpdateListener</code></p>
<p><em>Example:</em></p>
<pre><code class="language-java"><span class="hljs-comment">//...</span>
mMobileAccess.setReaderUpdateListener(<span class="hljs-keyword">this</span>);
<span class="hljs-comment">//...</span>

<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onReaderUpdated</span><span class="hljs-params">(ReaderAttributes reader, ReaderUpdateType readerUpdateType)</span> </span>{
    <span class="hljs-keyword">if</span>(readerUpdateType.equals(ReaderUpdateType.ATTRIBUTES_CHANGED)) {
        <span class="hljs-comment">// findReaderIndex should find the reader based on it's getId()</span>
        <span class="hljs-keyword">int</span> idx = findReaderIndex(reader);
        <span class="hljs-keyword">if</span>(idx == -<span class="hljs-number">1</span>) { <span class="hljs-comment">// a new reader</span>
            addReaderToList(reader);
        } <span class="hljs-keyword">else</span> {
            replaceReaderInList(idx, reader);
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(readerUpdateType.equals(ReaderUpdateType.READER_UNAVAILABLE)) {
        <span class="hljs-keyword">int</span> idx = findReaderIndex(reader);
        <span class="hljs-keyword">if</span>(idx &gt;= <span class="hljs-number">0</span>) {
            removeReaderFromList();
        }
    }
}
</code></pre>
<p>For a full example, refer to <code>ReadersFragment.java</code>, specifically the <code>onReaderUpdated</code> method of the <code>ReaderRecylerViewAdapter</code>.</p>
<p><strong>Reference:</strong><br>
<a href="javadoc/com/gallagher/security/mobileaccess/MobileAccess.html">MobileAccess</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/ReaderUpdateListener.html">ReaderUpdateListener</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/ReaderAttributes.html">ReaderAttributes</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/ReaderUpdateType.html">ReaderUpdateType</a></p>
<h3>3. Manual Connect<a name=reader_manualconnect></a></h3>
<p>Once you have discovered a reader, you can manually initiate an access request using the <code>requestAccess(reader, accessListener)</code> method. The SDK will asynchronously call the callback methods on the <code>accessListener</code> to inform you of success or failure. Callbacks will arive on the main thread.</p>
<p><em>Example:</em></p>
<pre><code class="language-java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onReaderClicked</span><span class="hljs-params">(Reader reader)</span> </span>{
    mMobileAccess.requestAccess(reader, <span class="hljs-keyword">this</span>);
}

<span class="hljs-comment">// ...</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onAccessStarted</span><span class="hljs-params">(@NonNull Reader reader)</span> </span>{
    updateDisplayState(reader, ACTIVE);
}

<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onAccessCompleted</span><span class="hljs-params">(@NonNull Reader reader, @Nullable AccessResult accessResult, @Nullable ReaderConnectionError error)</span> </span>{
    <span class="hljs-keyword">if</span>(error != <span class="hljs-keyword">null</span>) {
        updateDisplayState(reader, ERROR);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(accessResult != <span class="hljs-keyword">null</span>) {
        updateDisplayState(
            reader, 
            accessResult.isAccessGranted() ? GRANTED : DENIED);
    }
}
</code></pre>
<p>For a full example, refer to <code>ReadersFragment.java</code>, specifically the above-named methods in the <code>ReadersFragment</code> class</p>
<p><strong>Reference:</strong><br>
<a href="javadoc/com/gallagher/security/mobileaccess/MobileAccess.html">MobileAccess</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/Reader.html">Reader</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/AccessResult.html">AccessResult</a><br>
<a href="javadoc/com/gallagher/security/mobileaccess/ReaderConnectionError.html">ReaderConnectionError</a></p>
<h2>Frequently Asked Questions<a name=faq></a></h2>
<h3>1. Why does the device need screen lock / system-level PIN enabled? <a name=faq_device_pin_required></a></h3>
<p>If a user attempts to register a mobile credential on an Android device which does not have screen lock enabled, the registration operation will fail.</p>
<p>This is due to a technical implementation detail and is to improve security.</p>
<p>Internally, the Mobile Connect SDK stores two FIDO credentials for each site.</p>
<ol>
<li>The first-factor credential doesn't require any user-interaction, and is used when the Command Centre access zone is not in PINs mode.</li>
<li>The second-factor credential requires the mobile device user to input either a PIN or their fingerprint, and is used when the Command Centre Access Zone is in PINs mode.</li>
</ol>
<p>The second-factor credential needs to be more secure, because zones in PINs mode typically have much higher physical security requirements. As such, the Mobile Connect SDK requests that Android performs additional encryption on the keys associated with second-factor credentials. This is implemented in Android by using the screen lock feature, which is why credential registration requires screen lock to be enabled.</p>
<p>Refer <a href="https://developer.android.com/training/articles/keystore#UserAuthentication">https://developer.android.com/training/articles/keystore#UserAuthentication</a> for Android documentation.</p>
<p>Note that as per the Android documentation, if the user registers, then subsequently turns off their device level screen lock, then the second-factor keys will be invalidated. They will be able to authenticate against readers where the Access Zone is not in PINs mode, however if they attempt to authenticate where the second factor is required, this will fail. The only available solution is for that user to re-enable their screen lock, then repeat the registration process.</p>
<h2>Troubleshooting / Customising the SDK<a name=customising></a></h2>
<h3>1. Configuring Logging (optional) <a name=configure_logging></a></h3>
<p>If you encounter unexpected errors or behaviour, you may wish to enable logging from the SDK to help with troubleshooting.</p>
<p>Internally, the Android SDK uses the standard Java <strong>slf4j</strong> logging abstractions.
If your app uses an slf4j compatible logging framework, then log output from the SDK will be appended to your logs automatically.</p>
<p>If your app has a high log level (debug, verbose, etc) you may wish to filter out debug or verbose messages from the SDK; You can do this
by filtering log output from the package <code>com.gallagher.security</code></p>
<p>Configuration of Android logging frameworks is beyond the scope of this document, however the Android SDK sample application demonstrates using the logback-android framework to enable SDK log output.</p>
<h3>2. Configuring Android Notifications<a name=configure_notifications></a></h3>
<p>If your application uses the background access feature of the Mobile Connect SDK, then when the user encounters a reader that is configured to require a second factor, they will need to unlock the phone in order to complete the request. (For example, You can't prompt someone to enter a PIN when the phone is locked)</p>
<p>In order to facilite this, the SDK will show a pop-up notification asking the user to unlock their phone.</p>
<p>On Android versions 7 and older, the SDK is able to achieve this without requiring any support from the surrounding app (although you may optionally wish to customise the display of this pop-up notification - see <strong>Customising SDK messages</strong> below)</p>
<p>Android 8.0 (Oreo) introduced significant changes to the way Android applications manage notifications and background services.</p>
<p>Specifically, the Mobile Connect SDK is impacted by:</p>
<ul>
<li>On Android 8+, all notifications must be assigned a notification channel (<a href="https://developer.android.com/training/notify-user/channels.html">More Information</a>)</li>
<li>On Android 8+, persistent services are not allowed unless they display a &quot;foreground notification&quot; informing the user of their existence (<a href="https://developer.android.com/about/versions/oreo/background.html">More information</a>)</li>
</ul>
<p>What this means is that if you wish to use the Background Access feature of the SDK, you should create notification channels for the pop-up and persistent foreground notifications, and pass the channel ID's to the <code>MobileAccessProvider.configure(...)</code> method.</p>
<p>For more information, refer to <a href="https://developer.android.com/training/notify-user/channels.html">Google's &quot;Create and Manage Notification Channels&quot; documentation</a>, and refer to the <code>configureNotificationChannels</code> method in <code>Application.java</code> in the SDK sample application.</p>
<h3>3. Customising SDK messages<a name=configure_messages></a></h3>
<p>The SDK will at times need to prompt the user for information, such as to enter their fingerprint or passcode. By default the SDK will generate messages in English, however you have the ability to alter these messages - either to simply change the message text to better suit your application, or to translate it into other languages.</p>
<p>The SDK uses Android's resource system to manage these messages. In the SDK we define a number of string and image resources; If you wish to customise them, you can declare resources with the same ID's in your host application, which will override the resources from the SDK.</p>
<p>For a full example refer to the strings.xml, colors.xml and other resources in the SDK sample application</p>
<h4>3.1. Notification Details</h4>
<p><strong>Pop-up &quot;unlock device&quot; notifications:</strong></p>
<p>As above, if you have enabled background access, the SDK will show a pop-up notification asking the user to unlock their device if needed.</p>
<p>To customise the appearance of this notification, do the following:</p>
<p><code>strings.xml</code></p>
<pre><code class="language-xml"><span class="hljs-comment">&lt;!-- This will be passed to String.format, %s is optional and will be substituted for the reader name.
If you do not customise this, the default is [%s]. 
The Gallagher Mobile Connect application customises this to put the App name here with no substitution --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ggl_unlock_notification_title"</span>&gt;</span>Unlock Title: %s<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>

<span class="hljs-comment">&lt;!-- This will be passed to String.format, %s is optional and will be substituted for the reader name.
If you do not customise this, the default is [Unlock for "%s"]. --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ggl_unlock_notification_message"</span>&gt;</span>Unlock Body: "%s"<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
</code></pre>
<p><code>icon:</code></p>
<p>Create a vector xml drawable and give it the name of <code>ic_ggl_mobile_access_scanning_icon</code>.
If you do not customise this, the default icon is the <a href="https://material.io/icons/#ic_tap_and_play">&quot;tap and play&quot; icon from the Material Design icon set</a></p>
<p><strong>Persistent foreground notification:</strong>
As above, Android 8 or newer require a persistent foreground notification to allow scanning for Bluetooth readers in the background.
To customise the appearance of this notification, do the following:</p>
<p><code>strings.xml</code></p>
<pre><code class="language-xml"><span class="hljs-comment">&lt;!-- If you do not customise this, the default message is "Scanning for door access" --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ggl_foreground_notification_title"</span>&gt;</span>Notification Title<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
</code></pre>
<p><code>colors.xml</code></p>
<pre><code class="language-xml"><span class="hljs-comment">&lt;!-- If you do not customise this, the default color is #ff8400 --&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ggl_foreground_notification_color"</span>&gt;</span>#somecolor<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span>
</code></pre>
<p><code>icon:</code></p>
<p>Create a vector xml drawable and give it the name of <code>ic_ggl_mobile_access_scanning_icon</code>.
If you do not customise this, the default icon is the <a href="https://material.io/icons/#ic_tap_and_play">&quot;tap and play&quot; icon from the Material Design icon set</a></p>
<p>Note: the same icon is used for unlock notifications and the persistent foreground notification.</p>
<h4>3.2 Registration Details</h4>
<p>When the user registers a mobile credential, the SDK will ask them for either their PIN or Fingerprint, as per the <a href="#registration">registration</a> section earlier in this document.</p>
<p>To customise the apperance of the registration prompts, do the following:</p>
<p><code>strings.xml</code></p>
<pre><code class="language-xml"><span class="hljs-comment">&lt;!-- This will be passed to String.format, %s is optional and will be substituted for the site/company name.
If you do not customise this, the default is an empty string, which will not show a title --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ggl_mobilecredential_register_title"</span>&gt;</span>Your title: %s<span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>
<span class="hljs-comment">&lt;!-- This will be passed to String.format, %s is optional and will be substituted for the site/company name.
If you do not customise this, the default is [Register for "%s"] --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ggl_mobilecredential_register_message"</span>&gt;</span>Register for "%s"<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
</code></pre>
<p><span style='color:red'>Still to be confirmed: the remaining resources and text for the PIN and fingerprint UI</span></p>
<h4>3.3 Authentication Details</h4>
<p>When the user attempts to access a door that requires second factor authentication, the SDK will ask them for either their PIN or Fingerprint - whatever they chose when they previously registered their credential.</p>
<p>To customise the apperance of the authentication prompts, do the following:</p>
<p><code>strings.xml</code></p>
<pre><code class="language-xml"><span class="hljs-comment">&lt;!-- This will be passed to String.format, %s is optional and will be substituted for the reader name.
If you do not customise this, the default is [%s] --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ggl_mobilecredential_authenticate_title"</span>&gt;</span>Your title: %s<span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>
<span class="hljs-comment">&lt;!-- This will be passed to String.format, %s is optional and will be substituted for the reader name.
If you do not customise this, the default is [Register for "%s"] --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ggl_mobilecredential_authenticate_message"</span>&gt;</span>Authenticate for "%s"<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
</code></pre>
</body>
</html>